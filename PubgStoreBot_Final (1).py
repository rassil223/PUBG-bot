# -*- coding: utf-8 -*-
# ============================================
# Ù…Ù„Ù Ø¨ÙˆØª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… Ù„Ø´Ø­Ù† Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ - REMA STORE
#
# ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:
# 1. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†:
#    - Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±Ù Ø¬Ø¯ÙŠØ¯: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ù…Ø± ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø«Ù… â• Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±Ù ÙˆØ£Ø±Ø³Ù„ @username Ø£Ùˆ Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø±Ù‚Ù…ÙŠ.
#    - Ù„Ø­Ø°Ù Ù…Ø´Ø±Ù: ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø¨Ø¬Ø§Ù†Ø¨ ÙƒÙ„ Ù…Ø´Ø±Ù.
# 2. ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±:
#    - Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…ØŒ Ø§Ø®ØªØ± ğŸ’° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±ØŒ Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ ÙˆØ£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯.
# 3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª:
#    - Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…ØŒ Ø§Ø®ØªØ± ğŸŸï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§ØªØŒ Ø«Ù… â• Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¨ÙˆÙ† ÙˆØ§Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙˆÙ‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ….
#    - ÙŠØ·Ø¨Ù‚ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† Ø¹Ù„Ù‰ Ø£ÙˆÙ„ Ø·Ù„Ø¨ Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù….
# 4. Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:
#    - Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…ØŒ Ø§Ø®ØªØ± ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ø¹Ø±Ø¶ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†ØŒ Ø§Ù„Ø·Ù„Ø¨Ø§ØªØŒ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†ØŒ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª Ø§Ù„ÙØ¹Ø§Ù„Ø©.
#
# Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª: python PubgStoreBot_Final.py
# ============================================

import telebot
from telebot import types
import random
import pyotp
import time
from datetime import datetime, timedelta
import pytz
import sqlite3
from threading import Timer

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª
TOKEN = '7995774911:AAFi0STyX4w91O8IiZYYtfQRRoMRAMe4sdk'
ADMIN_CHANNEL = '@remabott'
SUPPORT_TELEGRAM = '@T_J3H'
SUPPORT_WHATSAPP = '+447405971105'
DEV_ACCOUNT = '@S_QlQ'
NEWS_CHANNEL = 'https://t.me/REMA_STORE0'

# Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø§Ù„Ø¨ÙˆØª
bot = telebot.TeleBot(TOKEN)

# Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ÙŠÙ†
def get_admins():
    conn = sqlite3.connect('rema_store.db')
    cursor = conn.cursor()

    # Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS admins (
        user_id INTEGER PRIMARY KEY,
        username TEXT,
        added_by INTEGER,
        added_date TEXT,
        is_active BOOLEAN DEFAULT TRUE
    )
    ''')

    # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙØ§Ø±ØºØ§Ù‹
    cursor.execute('SELECT COUNT(*) FROM admins')
    if cursor.fetchone()[0] == 0:
        cursor.execute('''
        INSERT INTO admins (user_id, username, added_by, added_date, is_active)
        VALUES (?, ?, ?, ?, ?)
        ''', (7973933950, 'default_admin', 7973933950, datetime.now().strftime('%Y-%m-%d %H:%M:%S'), True))
        conn.commit()

    # Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ† ÙÙ‚Ø·
    cursor.execute('SELECT user_id FROM admins WHERE is_active = TRUE')
    admins = [row[0] for row in cursor.fetchall()]
    conn.close()
    return admins

def is_admin(user_id):
    return user_id in get_admins()

@bot.message_handler(func=lambda message: message.text == 'ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†')
def manage_admins(message):
    if not is_admin(message.from_user.id):
        bot.reply_to(message, "â›” Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·")
        return

    markup = types.InlineKeyboardMarkup(row_width=2)
    markup.add(
        types.InlineKeyboardButton("â• Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±Ù", callback_data="add_admin"),
        types.InlineKeyboardButton("ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†", callback_data="list_admins"),
        types.InlineKeyboardButton("â†©ï¸ Ø±Ø¬ÙˆØ¹", callback_data="back_to_admin")
    )

    bot.send_message(message.chat.id, """
ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†:

â€¢ Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±Ù Ø¬Ø¯ÙŠØ¯ØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±Ù"
â€¢ Ù„Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙˆØ¥Ø¯Ø§Ø±ØªÙ‡Ù…ØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†"
    """, reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data == 'add_admin')
def add_admin_handler(call):
    if not is_admin(call.from_user.id):
        bot.answer_callback_query(call.id, "â›” Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·")
        return

    msg = bot.send_message(call.message.chat.id, """
ğŸ‘¤ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯:
- ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹Ø±Ù ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… (Ù…Ø«Ø§Ù„: @username)
- Ø£Ùˆ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢ÙŠØ¯ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø© (Ù…Ø«Ø§Ù„: 123456789)
    """)
    bot.register_next_step_handler(msg, process_new_admin)

def process_new_admin(message):
    try:
        admin_input = message.text.strip()

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¯Ø®Ù„ (Ù…Ø¹Ø±Ù Ø£Ùˆ Ø¢ÙŠØ¯ÙŠ)
        if admin_input.startswith('@'):
            # Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¹Ø±ÙØŒ Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¢ÙŠØ¯ÙŠ
            admin_info = bot.get_chat(admin_input)
            new_admin_id = admin_info.id
            admin_username = admin_input
        else:
            # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¢ÙŠØ¯ÙŠ Ù…Ø¨Ø§Ø´Ø±
            new_admin_id = int(admin_input)
            admin_username = str(new_admin_id)

        conn = sqlite3.connect('rema_store.db')
        cursor = conn.cursor()

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø´Ø±Ù Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹
        cursor.execute('SELECT user_id FROM admins WHERE user_id = ?', (new_admin_id,))
        if cursor.fetchone():
            bot.reply_to(message, "âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´Ø±Ù Ø¨Ø§Ù„ÙØ¹Ù„!")
            return

        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯
        cursor.execute('''
        INSERT INTO admins (user_id, username, added_by, added_date, is_active)
        VALUES (?, ?, ?, ?, ?)
        ''', (new_admin_id, admin_username, message.from_user.id, datetime.now().strftime('%Y-%m-%d %H:%M:%S'), True))

        conn.commit()
        conn.close()

        bot.reply_to(message, f"âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø±Ù {admin_username} Ø¨Ù†Ø¬Ø§Ø­")
        manage_admins(message)
    except Exception as e:
        bot.reply_to(message, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø±Ù. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¹Ø±Ù Ø£Ùˆ Ø§Ù„Ø¢ÙŠØ¯ÙŠ")
        manage_admins(message)

@bot.callback_query_handler(func=lambda call: call.data == 'list_admins')
def list_admins_handler(call):
    if not is_admin(call.from_user.id):
        bot.answer_callback_query(call.id, "â›” Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·")
        return

    conn = sqlite3.connect('rema_store.db')
    cursor = conn.cursor()
    cursor.execute('SELECT user_id, username, added_date FROM admins WHERE is_active = TRUE')
    admins = cursor.fetchall()
    conn.close()

    if not admins:
        bot.edit_message_text(
            "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø±ÙÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹",
            call.message.chat.id,
            call.message.message_id
        )
        return

    markup = types.InlineKeyboardMarkup(row_width=1)
    for admin_id, username, added_date in admins:
        btn = types.InlineKeyboardButton(
            f"ğŸ—‘ï¸ {username} (Ù…Ù†Ø° {added_date.split()[0]})",
            callback_data=f"remove_admin_{admin_id}"
        )
        markup.add(btn)

    markup.add(types.InlineKeyboardButton("â†©ï¸ Ø±Ø¬ÙˆØ¹", callback_data="back_to_admin_manage"))

    bot.edit_message_text(
        "ğŸ‘¥ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†:\n\nØ§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±Ù Ù„Ø¥Ø²Ø§Ù„ØªÙ‡",
        call.message.chat.id,
        call.message.message_id,
        reply_markup=markup
    )

@bot.callback_query_handler(func=lambda call: call.data.startswith('remove_admin_'))
def remove_admin_handler(call):
    if not is_admin(call.from_user.id):
        bot.answer_callback_query(call.id, "â›” Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·")
        return

    admin_id = int(call.data.split('_')[2])

    # Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø²Ø§Ù„Ø© Ù†ÙØ³Ùƒ
    if admin_id == call.from_user.id:
        bot.answer_callback_query(call.id, "âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø²Ø§Ù„Ø© Ù†ÙØ³Ùƒ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†")
        return

    conn = sqlite3.connect('rema_store.db')
    cursor = conn.cursor()
    cursor.execute('UPDATE admins SET is_active = FALSE WHERE user_id = ?', (admin_id,))
    conn.commit()
    conn.close()

    bot.answer_callback_query(call.id, "âœ… ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø±Ù Ø¨Ù†Ø¬Ø§Ø­")
    list_admins_handler(call)

@bot.callback_query_handler(func=lambda call: call.data == 'back_to_admin_manage')
def back_to_admin_manage(call):
    manage_admins(call.message)

@bot.callback_query_handler(func=lambda call: call.data == 'back_to_admin')
def back_to_admin(call):
    show_admin_panel(call.message.chat.id)

@bot.message_handler(func=lambda message: message.text == 'ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†')
def manage_users(message):
    if not is_admin(message.from_user.id):
        return

    markup = types.InlineKeyboardMarkup(row_width=2)
    markup.add(
        types.InlineKeyboardButton("ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…", callback_data="search_user"),
        types.InlineKeyboardButton("ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", callback_data="user_stats")
    )

    bot.send_message(message.chat.id, "ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:", reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data == 'search_user')
def search_user(call):
    if not is_admin(call.from_user.id):
        return

    msg = bot.send_message(call.message.chat.id, "ğŸ” Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:")
    bot.register_next_step_handler(msg, process_user_search)

def process_user_search(message):
    search_term = message.text

    conn = sqlite3.connect('rema_store.db')
    cursor = conn.cursor()

    cursor.execute('''
    SELECT user_id, full_name, phone, player_id, registration_date
    FROM users
    WHERE user_id = ? OR phone = ?
    ''', (search_term, search_term))

    user = cursor.fetchone()
    conn.close()

    if user:
        markup = types.InlineKeyboardMarkup()
        block_btn = types.InlineKeyboardButton(
            "ğŸš« Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" if not user[5] else "âœ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±",
            callback_data=f"toggle_block_{user[0]}"
        )
        markup.add(block_btn)

        bot.send_message(message.chat.id, f"""
ğŸ” Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:

ğŸ‘¤ Ø§Ù„Ù…Ø¹Ø±Ù: {user[0]}
ğŸ“ Ø§Ù„Ø§Ø³Ù…: {user[1]}
ğŸ“± Ø§Ù„Ù‡Ø§ØªÙ: {user[2]}
ğŸ® ID Ø§Ù„Ù„Ø§Ø¹Ø¨: {user[3]}
ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„: {user[4]}
        """, reply_markup=markup)
    else:
        bot.reply_to(message, "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")

def is_admin(user_id):
    """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´Ø±ÙØ§Ù‹"""
    return user_id in ADMINS

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
WELCOME_GIF = "https://media.giphy.com/media/welcome.gif"  # Ø±Ø§Ø¨Ø· GIF Ø§Ù„ØªØ±Ø­ÙŠØ¨
DISCOUNT_CODES = {
    "WELCOME10": 10,  # Ø®ØµÙ… 10%
    "SUMMER25": 25    # Ø®ØµÙ… 25%
}

import shutil
from datetime import datetime
import os

# Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø§Ù„Ø¨ÙˆØª
bot = telebot.TeleBot(TOKEN)

# ÙˆØ¸Ø§Ø¦Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
def backup_database():
    """Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
    try:
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        backup_dir = 'db_backups'
        if not os.path.exists(backup_dir):
            os.makedirs(backup_dir)
        backup_path = f'{backup_dir}/rema_store_{timestamp}.db'
        shutil.copy2('rema_store.db', backup_path)
        # Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 5 Ù†Ø³Ø®)
        backup_files = sorted([f for f in os.listdir(backup_dir) if f.endswith('.db')])
        while len(backup_files) > 5:
            os.remove(os.path.join(backup_dir, backup_files.pop(0)))
        print(f"âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: {backup_path}")
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ: {e}")

def init_db():
    conn = sqlite3.connect('rema_store.db')
    cursor = conn.cursor()

    # Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS users (
        user_id INTEGER PRIMARY KEY,
        username TEXT,
        full_name TEXT,
        phone TEXT,
        player_id TEXT,
        registration_date TEXT,
        last_used_date TEXT,
        telegram_username TEXT,
        language_code TEXT DEFAULT 'ar',
        is_blocked BOOLEAN DEFAULT FALSE,
        settings TEXT
    )
    ''')

    # Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS orders (
        order_id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        game_name TEXT,
        uc_amount TEXT,
        player_id TEXT,
        price INTEGER,
        paid_amount INTEGER,
        payment_method TEXT,
        status TEXT DEFAULT 'pending',
        order_date TEXT,
        completion_date TEXT,
        payment_proof TEXT,
        admin_notes TEXT,
        FOREIGN KEY (user_id) REFERENCES users (user_id)
    )
    ''')

    # Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¨ÙˆØª
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS bot_messages (
        chat_id INTEGER,
        message_id INTEGER,
        is_permanent BOOLEAN DEFAULT FALSE,
        message_type TEXT,
        created_at TEXT,
        PRIMARY KEY (chat_id, message_id)
    )
    ''')

    # Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS rewards (
        user_id INTEGER PRIMARY KEY,
        points INTEGER DEFAULT 0,
        total_spent INTEGER DEFAULT 0,
        rank TEXT DEFAULT 'bronze',
        last_reward_date TEXT,
        referral_code TEXT UNIQUE,
        referred_by INTEGER,
        FOREIGN KEY (user_id) REFERENCES users (user_id),
        FOREIGN KEY (referred_by) REFERENCES users (user_id)
    )
    ''')

    # Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS coupons (
        code TEXT PRIMARY KEY,
        discount_type TEXT,
        discount_value INTEGER,
        min_purchase INTEGER,
        max_uses INTEGER,
        current_uses INTEGER DEFAULT 0,
        start_date TEXT,
        end_date TEXT,
        is_active BOOLEAN DEFAULT TRUE
    )
    ''')

    # Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS coupon_usage (
        code TEXT,
        user_id INTEGER,
        order_id INTEGER,
        used_date TEXT,
        discount_amount INTEGER,
        PRIMARY KEY (code, user_id, order_id),
        FOREIGN KEY (code) REFERENCES coupons (code),
        FOREIGN KEY (user_id) REFERENCES users (user_id),
        FOREIGN KEY (order_id) REFERENCES orders (order_id)
    )
    ''')

    # Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS products (
        product_id INTEGER PRIMARY KEY AUTOINCREMENT,
        game_name TEXT,
        product_name TEXT,
        description TEXT,
        price INTEGER,
        is_active BOOLEAN DEFAULT TRUE,
        created_at TEXT,
        updated_at TEXT
    )
    ''')

    conn.commit()
    conn.close()

init_db()

# Ù‚Ø§Ù…ÙˆØ³ Ù„Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
user_data = {}
otp_secrets = {}
otp_attempts = {}
pending_orders = {}
reminder_timers = {}

# Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
ADMINS = [7973933950]  # ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ù‡Ù†Ø§

# Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ (8 ØµØ¨Ø§Ø­Ù‹Ø§ Ø¥Ù„Ù‰ 11 Ù…Ø³Ø§Ø¡Ù‹ Ø¨ØªÙˆÙ‚ÙŠØª Ø³ÙˆØ±ÙŠØ§)
WORKING_HOURS = {
    'start': 8,
    'end': 23
}

# Ø£Ø³Ø¹Ø§Ø± UC
UC_PRICES = {
    '60_UC': 11500,
    '120_UC': 23000,
    '180_UC': 34000,
    '325_UC': 56000,
    '660_UC': 112000,
    '1800_UC': 273000,
    '3850_UC': 530000,
    '8100_UC': 1070000
}

# ---------------------------
# ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø©
# ---------------------------

def get_current_time():
    damascus_tz = pytz.timezone('Asia/Damascus')
    return datetime.now(damascus_tz)

def is_bot_working_hours():
    now = get_current_time()
    current_hour = now.hour
    return WORKING_HOURS['start'] <= current_hour < WORKING_HOURS['end']

def clean_chat(chat_id, keep_permanent=True):
    conn = sqlite3.connect('rema_store.db')
    cursor = conn.cursor()

    if keep_permanent:
        cursor.execute('SELECT message_id FROM bot_messages WHERE chat_id = ? AND is_permanent = FALSE ORDER BY message_id DESC', (chat_id,))
    else:
        cursor.execute('SELECT message_id FROM bot_messages WHERE chat_id = ? ORDER BY message_id DESC', (chat_id,))

    messages = cursor.fetchall()

    for msg_id in messages:
        try:
            bot.delete_message(chat_id, msg_id[0])
            cursor.execute('DELETE FROM bot_messages WHERE chat_id = ? AND message_id = ?', (chat_id, msg_id[0]))
        except:
            pass

    conn.commit()
    conn.close()

def add_to_history(chat_id, message_id, is_permanent=False):
    conn = sqlite3.connect('rema_store.db')
    cursor = conn.cursor()
    cursor.execute('INSERT OR IGNORE INTO bot_messages VALUES (?, ?, ?)', (chat_id, message_id, is_permanent))
    conn.commit()
    conn.close()

def delete_user_message(chat_id, message_id):
    try:
        bot.delete_message(chat_id, message_id)
    except:
        pass

def send_clean_message(chat_id, text, reply_markup=None, parse_mode=None, is_permanent=False):
    clean_chat(chat_id, keep_permanent=True)
    msg = bot.send_message(chat_id, text, reply_markup=reply_markup, parse_mode=parse_mode)
    add_to_history(chat_id, msg.message_id, is_permanent)
    return msg

def get_user_data(user_id):
    conn = sqlite3.connect('rema_store.db')
    cursor = conn.cursor()
    cursor.execute('SELECT full_name, phone, player_id FROM users WHERE user_id = ?', (user_id,))
    result = cursor.fetchone()
    conn.close()

    if result:
        return {
            'full_name': result[0],
            'phone': result[1],
            'player_id': result[2]
        }
    return None

def save_user(user_id, username, full_name, phone, player_id=None):
    conn = sqlite3.connect('rema_store.db')
    cursor = conn.cursor()

    cursor.execute('''
    INSERT OR REPLACE INTO users 
    (user_id, username, full_name, phone, player_id, registration_date, last_used_date)
    VALUES (?, ?, ?, ?, ?, ?, ?)
    ''', (
        user_id, 
        username, 
        full_name, 
        phone, 
        player_id,
        get_current_time().strftime('%Y-%m-%d %H:%M:%S'),
        get_current_time().strftime('%Y-%m-%d %H:%M:%S')
    ))

    conn.commit()
    conn.close()

def create_order(user_id, game_name, uc_amount, player_id, price, paid_amount, payment_method):
    conn = sqlite3.connect('rema_store.db')
    cursor = conn.cursor()

    cursor.execute('''
    INSERT INTO orders (user_id, game_name, uc_amount, player_id, price, paid_amount, payment_method, order_date)
    VALUES (?, ?, ?, ?, ?, ?, ?, ?)
    ''', (user_id, game_name, uc_amount, player_id, price, paid_amount, payment_method, 
          get_current_time().strftime('%Y-%m-%d %H:%M:%S')))

    order_id = cursor.lastrowid

    conn.commit()
    conn.close()

    return order_id

def get_user_orders(user_id):
    conn = sqlite3.connect('rema_store.db')
    cursor = conn.cursor()

    cursor.execute('''
    SELECT order_id, game_name, uc_amount, status, order_date FROM orders 
    WHERE user_id = ? ORDER BY order_date DESC
    ''', (user_id,))

    orders = cursor.fetchall()
    conn.close()

    return orders

def get_order_status(order_id):
    conn = sqlite3.connect('rema_store.db')
    cursor = conn.cursor()

    cursor.execute('SELECT status FROM orders WHERE order_id = ?', (order_id,))
    result = cursor.fetchone()
    conn.close()

    return result[0] if result else None

def update_order_status(order_id, status):
    conn = sqlite3.connect('rema_store.db')
    cursor = conn.cursor()

    cursor.execute('''
    UPDATE orders SET status = ?, completion_date = ?
    WHERE order_id = ?
    ''', (status, get_current_time().strftime('%Y-%m-%d %H:%M:%S'), order_id))

    conn.commit()
    conn.close()

def schedule_reminder(chat_id, order_id=None):
    if chat_id in reminder_timers:
        reminder_timers[chat_id].cancel()

    def send_reminder():
        markup = types.InlineKeyboardMarkup()
        if order_id:
            btn = types.InlineKeyboardButton("âš¡ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨", callback_data=f"complete_order_{order_id}")
        else:
            btn = types.InlineKeyboardButton("âš¡ Ø§Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¢Ù†", callback_data="start_order")
        markup.add(btn)

        send_clean_message(chat_id, "âš¡ Ù…Ø§ Ø²Ù„Øª ØªØ±ØºØ¨ Ø¨Ø¥ÙƒÙ…Ø§Ù„ Ø´Ø­Ù† Ø´Ø¯Ø§ØªÙƒØŸ Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©!", reply_markup=markup)

    reminder_timers[chat_id] = Timer(1800, send_reminder)
    reminder_timers[chat_id].start()

def format_order_id(order_id):
    return f"ğŸ†” #{order_id:06d}"

# ---------------------------
# Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø± ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„
# ---------------------------

@bot.message_handler(commands=['admin'])
def admin_panel(message):
    if not is_admin(message.from_user.id):
        bot.reply_to(message, "â›” Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·")
        return

    show_admin_panel(message.chat.id)

def show_admin_panel(chat_id):
    markup = types.ReplyKeyboardMarkup(row_width=2, resize_keyboard=True)

    btn1 = types.KeyboardButton('ğŸ’° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±')
    btn2 = types.KeyboardButton('ğŸŸï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª')
    btn3 = types.KeyboardButton('ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†')
    btn4 = types.KeyboardButton('ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†')
    btn5 = types.KeyboardButton('ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª')
    btn6 = types.KeyboardButton('ğŸ”™ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©')

    markup.add(btn1, btn2, btn3, btn4, btn5, btn6)

    bot.send_message(chat_id, """
ğŸ® Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø±Ù

Ø§Ø®ØªØ± Ø£Ø­Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ù„ØªØ­ÙƒÙ… Ø¨Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª:
    """, reply_markup=markup)

@bot.message_handler(func=lambda message: message.text == 'ğŸ’° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±')
def manage_prices(message):
    if not is_admin(message.from_user.id):
        return

    markup = types.InlineKeyboardMarkup(row_width=1)

    # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    conn = sqlite3.connect('rema_store.db')
    cursor = conn.cursor()
    cursor.execute('''CREATE TABLE IF NOT EXISTS uc_prices
                     (amount TEXT PRIMARY KEY, price INTEGER)''')
    conn.commit()

    # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© ÙØ§Ø±ØºØ©
    cursor.execute('SELECT COUNT(*) FROM uc_prices')
    if cursor.fetchone()[0] == 0:
        for amount, price in UC_PRICES.items():
            cursor.execute('INSERT INTO uc_prices VALUES (?, ?)', (amount, price))
        conn.commit()

    # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    cursor.execute('SELECT amount, price FROM uc_prices')
    prices = cursor.fetchall()
    conn.close()

    for amount, price in prices:
        btn = types.InlineKeyboardButton(
            f"{amount.replace('_', ' ')} - {price:,} Ù„.Ø³",
            callback_data=f"edit_price_{amount}"
        )
        markup.add(btn)

    markup.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="back_to_admin"))
    bot.send_message(message.chat.id, "ğŸ’° Ø§Ø®ØªØ± Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ¹Ø¯ÙŠÙ„Ù‡:", reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data == "back_to_admin")
def back_to_admin(call):
    show_admin_panel(call.message.chat.id)

@bot.callback_query_handler(func=lambda call: call.data.startswith('edit_price_'))
def edit_price(call):
    if not is_admin(call.from_user.id):
        return

    uc_amount = call.data.split('_')[2]
    user_data[call.message.chat.id] = {'editing_amount': uc_amount} # Store the UC amount being edited
    msg = bot.send_message(call.message.chat.id, f"ğŸ’° Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù€ {uc_amount.replace('_', ' ')}:")
    bot.register_next_step_handler(msg, process_new_price)

def process_new_price(message):
    try:
        new_price = int(message.text)
        if new_price <= 0:
            bot.reply_to(message, "âŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø³Ø¹Ø± Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±")
            return

        conn = sqlite3.connect('rema_store.db')
        cursor = conn.cursor()

        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        cursor.execute('''
        CREATE TABLE IF NOT EXISTS uc_prices (
            amount TEXT PRIMARY KEY,
            price INTEGER DEFAULT 0
        )
        ''')

        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ù„Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
        cursor.execute('''
        INSERT OR REPLACE INTO uc_prices (amount, price) 
        VALUES (?, ?)
        ''', (user_data[message.chat.id].get('editing_amount'), new_price))

        conn.commit()
        conn.close()

        bot.reply_to(message, f"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø³Ø¹Ø± {user_data[message.chat.id].get('editing_amount').replace('_', ' ')} Ø¥Ù„Ù‰ {new_price:,} Ù„.Ø³")
        manage_prices(message)
    except ValueError:
        bot.reply_to(message, "âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­")
        manage_prices(message)

@bot.message_handler(func=lambda message: message.text == 'ğŸŸï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª')
def manage_coupons(message):
    if not is_admin(message.from_user.id):
        return

    markup = types.InlineKeyboardMarkup(row_width=2)
    markup.add(
        types.InlineKeyboardButton("â• Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¨ÙˆÙ†", callback_data="add_coupon"),
        types.InlineKeyboardButton("ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª", callback_data="list_coupons")
    )

    bot.send_message(message.chat.id, "ğŸŸï¸ Ø¥Ø¯Ø§Ø±Ø© ÙƒÙˆØ¨ÙˆÙ†Ø§Øª Ø§Ù„Ø®ØµÙ…:", reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data == 'add_coupon')
def add_coupon(call):
    if not is_admin(call.from_user.id):
        return

    msg = bot.send_message(call.message.chat.id, """
ğŸŸï¸ Ø£Ø¯Ø®Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† Ø¨Ø§Ù„ØµÙŠØºØ© Ø§Ù„ØªØ§Ù„ÙŠØ©:
Ø§Ù„ÙƒÙˆØ¯ØŒÙ†Ø³Ø¨Ø©_Ø§Ù„Ø®ØµÙ…
Ù…Ø«Ø§Ù„: REMA50ØŒ50
    """)
    bot.register_next_step_handler(msg, process_new_coupon)

def process_new_coupon(message):
    try:
        code, discount = message.text.split('ØŒ')
        discount = int(discount)

        conn = sqlite3.connect('rema_store.db')
        cursor = conn.cursor()

        # Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ ÙˆØ¬Ø¯
        cursor.execute('DELETE FROM coupons WHERE code = ?', (code.lower(),))

        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯
        cursor.execute('''
        INSERT INTO coupons (code, discount_type, discount_value, is_active, start_date)
        VALUES (?, 'percentage', ?, TRUE, ?)
        ''', (code.lower(), discount, datetime.now().strftime('%Y-%m-%d %H:%M:%S')))

        conn.commit()
        conn.close()

        bot.reply_to(message, f"âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† {code} Ø¨Ù†Ø³Ø¨Ø© Ø®ØµÙ… {discount}%")
        manage_coupons(message)
    except Exception as e:
        print(f"Error adding coupon: {e}")
        bot.reply_to(message, "âŒ ØµÙŠØºØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©")
        manage_coupons(message)

@bot.callback_query_handler(func=lambda call: call.data == 'list_coupons')
def list_coupons(call):
    if not is_admin(call.from_user.id):
        return

    conn = sqlite3.connect('rema_store.db')
    cursor = conn.cursor()
    cursor.execute('SELECT code, discount_value, current_uses FROM coupons WHERE is_active = TRUE')
    coupons = cursor.fetchall()
    conn.close()

    if not coupons:
        bot.send_message(call.message.chat.id, "Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙˆØ¨ÙˆÙ†Ø§Øª Ù†Ø´Ø·Ø©")
        return

    markup = types.InlineKeyboardMarkup(row_width=1)
    for code, discount, uses in coupons:
        btn = types.InlineKeyboardButton(
            f"{code} - {discount}% (Ø§Ø³ØªØ®Ø¯Ù… {uses} Ù…Ø±Ø©)",
            callback_data=f"edit_coupon_{code}"
        )
        markup.add(btn)

    bot.edit_message_text(
        "ğŸŸï¸ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©:",
        call.message.chat.id,
        call.message.message_id,
        reply_markup=markup
    )

@bot.message_handler(commands=['start', 'restart'])
def send_welcome(message):
    if not is_bot_working_hours():
        bot.send_message(message.chat.id, "â³ Ø¹Ø°Ø±Ù‹Ø§ØŒ Ø§Ù„Ø¨ÙˆØª Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠÙ‹Ø§\n\nØ³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ù…Ù† 8 ØµØ¨Ø§Ø­Ù‹Ø§ Ø¥Ù„Ù‰ 11 Ù…Ø³Ø§Ø¡Ù‹ Ø¨ØªÙˆÙ‚ÙŠØª Ø³ÙˆØ±ÙŠØ§")
        return

    markup = types.ReplyKeyboardMarkup(row_width=2, resize_keyboard=True)

    btn1 = types.KeyboardButton('ğŸ® Ø´Ø­Ù† Ø£Ù„Ø¹Ø§Ø¨')
    btn2 = types.KeyboardButton('ğŸ“ ØªÙˆØ§ØµÙ„')
    btn3 = types.KeyboardButton('ğŸ“¢ Ù‚Ù†Ø§Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø±')
    btn4 = types.KeyboardButton('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„')
    btn5 = types.KeyboardButton('ğŸ“‹ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨')
    btn6 = types.KeyboardButton('ğŸŸï¸ ÙƒÙˆØ¨ÙˆÙ† Ø®ØµÙ…')
    btn7 = types.KeyboardButton('ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ')

    markup.add(btn1, btn2, btn3, btn4, btn5, btn6, btn7)

    welcome_photo = "https://i.postimg.cc/B6F8qDw8/retro-arcade-gaming-cabinet-night-scene-tsq7vihg9g1ycnv8.webp"  # Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©
    welcome_msg = """
âœ¨ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ù…ØªØ¬Ø± Ø±ÙŠÙ…Ø§ REMA STORE!

ğŸ›’ Ø®Ø¯Ù…Ø§ØªÙ†Ø§:
ğŸ”¹ Ø´Ø­Ù† Ø£Ù„Ø¹Ø§Ø¨ Ø³Ø±ÙŠØ¹ ÙˆØ¢Ù…Ù†
ğŸ”¹ Ø£Ø³Ø¹Ø§Ø± Ù…Ù†Ø§ÙØ³Ø© ÙˆÙ…Ù…ÙŠØ²Ø©
ğŸ”¹ Ø¯Ø¹Ù… ÙÙ†ÙŠ Ù…ØªÙˆØ§ØµÙ„ 24/7

Ø§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬Ù‡Ø§ Ø¹Ø¨Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø§Ù„Ø£Ø³ÙÙ„!

á´¾Ê³áµ’áµÊ³áµƒáµáµâ±â¿áµ áµ‡Ê¸ á´¿áµƒË¢Ë¢â±Ë¡
    """

    try:
        photo = bot.send_photo(message.chat.id, welcome_photo, caption=welcome_msg, reply_markup=markup)
        add_to_history(message.chat.id, photo.message_id, is_permanent=True)
    except Exception as e:
        print(f"Error sending photo: {e}")
        send_clean_message(message.chat.id, welcome_msg, reply_markup=markup, is_permanent=True)

@bot.message_handler(func=lambda message: message.text == 'ğŸŸï¸ ÙƒÙˆØ¨ÙˆÙ† Ø®ØµÙ…')
def discount_coupon(message):
    markup = types.InlineKeyboardMarkup()
    msg_btn = types.InlineKeyboardButton("ğŸ’¬ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¨ÙˆÙ†", callback_data="enter_coupon")
    back_btn = types.InlineKeyboardButton("â†©ï¸ Ø±Ø¬ÙˆØ¹", callback_data="back_to_main")
    markup.add(msg_btn, back_btn)

    send_clean_message(message.chat.id, """
ğŸŸï¸ ÙƒÙˆØ¨ÙˆÙ†Ø§Øª Ø§Ù„Ø®ØµÙ…:

Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø®ØµÙ… ÙÙˆØ±ÙŠ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ù‚Ø§Ø¯Ù…!
    """, reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data == 'enter_coupon')
def enter_coupon(call):
    chat_id = call.message.chat.id
    msg = send_clean_message(chat_id, "ğŸŸï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†:")
    bot.register_next_step_handler(msg, process_coupon)

def process_coupon(message):
    chat_id = message.chat.id
    coupon_code = message.text.lower()
    user_id = message.from_user.id

    conn = sqlite3.connect('rema_store.db')
    cursor = conn.cursor()

    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† ÙˆØµÙ„Ø§Ø­ÙŠØªÙ‡
    cursor.execute('''
    SELECT discount_value FROM coupons 
    WHERE code = ? AND is_active = TRUE
    ''', (coupon_code,))
    coupon = cursor.fetchone()

    if not coupon:
        send_clean_message(chat_id, "âŒ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† ØºÙŠØ± ØµØ§Ù„Ø­")
        conn.close()
        return

    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† Ø³Ø§Ø¨Ù‚Ø§Ù‹
    cursor.execute('''
    SELECT COUNT(*) FROM coupon_usage 
    WHERE code = ? AND user_id = ?
    ''', (coupon_code, user_id))
    used_count = cursor.fetchone()[0]

    if used_count > 0:
        send_clean_message(chat_id, "âš ï¸ Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù‚Ø¯ Ø§Ø³ØªØ®Ø¯Ù…Øª Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† Ù…Ù† Ù‚Ø¨Ù„!")
        conn.close()
        return

    discount_value = coupon[0]

    if coupon_code in discounts:
        # Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        cursor.execute('''
        INSERT INTO coupon_usage (code, user_id, used_date)
        VALUES (?, ?, ?)
        ''', (coupon_code, user_id, datetime.now().strftime('%Y-%m-%d %H:%M:%S')))
        conn.commit()

        markup = types.InlineKeyboardMarkup()
        use_now_btn = types.InlineKeyboardButton("ğŸ›ï¸ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ù†", callback_data="start_order")
        back_btn = types.InlineKeyboardButton("â†©ï¸ Ø±Ø¬ÙˆØ¹", callback_data="back_to_main")
        markup.add(use_now_btn, back_btn)

        send_clean_message(chat_id, f"""
âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­!

ğŸ’° Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ…: {discounts[coupon_code]}%

ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø¢Ù† ÙÙŠ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ù‚Ø§Ø¯Ù….
        """, reply_markup=markup)

        # ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø®ØµÙ… ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        user_data[chat_id] = user_data.get(chat_id, {})
        user_data[chat_id]['discount'] = discounts[coupon_code]
    else:
        markup = types.InlineKeyboardMarkup()
        try_again_btn = types.InlineKeyboardButton("ğŸ”„ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰", callback_data="enter_coupon")
        back_btn = types.InlineKeyboardButton("â†©ï¸ Ø±Ø¬ÙˆØ¹", callback_data="back_to_main")
        markup.add(try_again_btn, back_btn)

        send_clean_message(chat_id, "âŒ Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† ØºÙŠØ± ØµØ§Ù„Ø­!", reply_markup=markup)

    conn.close()

@bot.message_handler(func=lambda message: message.text == 'ğŸ“‹ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨')
def order_status(message):
    user_id = message.from_user.id
    orders = get_user_orders(user_id)

    if not orders:
        markup = types.InlineKeyboardMarkup()
        back_btn = types.InlineKeyboardButton("â†©ï¸ Ø±Ø¬ÙˆØ¹", callback_data="back_to_main")
        markup.add(back_btn)

        send_clean_message(message.chat.id, "âš ï¸ Ø£Ù†Øª Ù„Ù… ØªÙ‚Ù… Ø¨Ø·Ù„Ø¨ Ø£ÙŠ Ø·Ù„Ø¨ Ø¨Ø¹Ø¯!", reply_markup=markup)
    else:
        markup = types.InlineKeyboardMarkup(row_width=1)
        for order in orders:
            order_id, game_name, uc_amount, status, order_date = order
            btn = types.InlineKeyboardButton(
                f"{format_order_id(order_id)} - {status}",
                callback_data=f"order_details_{order_id}"
            )
            markup.add(btn)

        back_btn = types.InlineKeyboardButton("â†©ï¸ Ø±Ø¬ÙˆØ¹", callback_data="back_to_main")
        markup.add(back_btn)

        send_clean_message(message.chat.id, "ğŸ“‹ Ø§Ø®ØªØ± Ø§Ù„Ø·Ù„Ø¨ Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„:", reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data.startswith('order_details_'))
def show_order_details(call):
    order_id = int(call.data.split('_')[2])
    user_id = call.from_user.id

    conn = sqlite3.connect('rema_store.db')
    cursor = conn.cursor()

    cursor.execute('''
    SELECT game_name, uc_amount, player_id, price, paid_amount, payment_method, status, order_date
    FROM orders WHERE order_id = ? AND user_id = ?
    ''', (order_id, user_id))

    order = cursor.fetchone()
    conn.close()

    if order:
        game_name, uc_amount, player_id, price, paid_amount, payment_method, status, order_date = order

        status_emojis = {
            'pending': 'â³',
            'processing': 'ğŸ”„',
            'completed': 'âœ…',
            'rejected': 'âŒ'
        }

        details = f"""
ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ {format_order_id(order_id)}

ğŸ® Ø§Ù„Ù„Ø¹Ø¨Ø©: {game_name}
ğŸ’° Ø§Ù„ÙØ¦Ø©: {uc_amount}
ğŸ’µ Ø§Ù„Ø³Ø¹Ø±: {price} Ù„.Ø³
ğŸ†” ID Ø§Ù„Ù„Ø§Ø¹Ø¨: {player_id}
ğŸ’³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: {payment_method}
ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨: {order_date}
ğŸ”„ Ø§Ù„Ø­Ø§Ù„Ø©: {status_emojis.get(status, '')} {status}
        """

        markup = types.InlineKeyboardMarkup()
        back_btn = types.InlineKeyboardButton("â†©ï¸ Ø±Ø¬ÙˆØ¹", callback_data="back_to_orders")
        markup.add(back_btn)

        bot.edit_message_text(
            chat_id=call.message.chat.id,
            message_id=call.message.message_id,
            text=details,
            reply_markup=markup
        )
    else:
        bot.answer_callback_query(call.id, "âš ï¸ Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¹Ø±Ø¶Ù‡")

@bot.callback_query_handler(func=lambda call: call.data == 'back_to_orders')
def back_to_orders(call):
    order_status(call.message)

@bot.message_handler(func=lambda message: message.text == 'ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„')
def restart_bot(message):
    send_welcome(message)

@bot.message_handler(func=lambda message: message.text == 'ğŸ® Ø´Ø­Ù† Ø£Ù„Ø¹Ø§Ø¨')
def game_charging(message):
    if not is_bot_working_hours():
        bot.send_message(message.chat.id, "â³ Ø¹Ø°Ø±Ù‹Ø§ØŒ Ø§Ù„Ø¨ÙˆØª Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠÙ‹Ø§\n\nØ³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ù…Ù† 8 ØµØ¨Ø§Ø­Ù‹Ø§ Ø¥Ù„Ù‰ 11 Ù…Ø³Ø§Ø¡Ù‹ Ø¨ØªÙˆÙ‚ÙŠØª Ø³ÙˆØ±ÙŠØ§")
        return

    markup = types.InlineKeyboardMarkup(row_width=1)

    btn_pubg = types.InlineKeyboardButton("ğŸ¯ Ø´Ø­Ù† PUBG", callback_data="pubg_charging")
    btn_other = types.InlineKeyboardButton("ğŸ® Ø£Ù„Ø¹Ø§Ø¨ Ø£Ø®Ø±Ù‰ (Ù‚Ø±ÙŠØ¨Ù‹Ø§)", callback_data="coming_soon")
    btn_back = types.InlineKeyboardButton("â†©ï¸ Ø±Ø¬ÙˆØ¹", callback_data="back_to_main")

    markup.add(btn_pubg, btn_other, btn_back)

    send_clean_message(message.chat.id, "ğŸ® Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø´Ø­Ù†:", reply_markup=markup)

    schedule_reminder(message.chat.id)

@bot.callback_query_handler(func=lambda call: call.data == 'pubg_charging')
def pubg_charging(call):
    chat_id = call.message.chat.id
    markup = types.InlineKeyboardMarkup(row_width=2)

    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
    discount = user_data.get(chat_id, {}).get('discount', 0)

    uc_prices_list = [
        ("60 UC", "60_UC", 11500),
        ("120 UC", "120_UC", 23000),
        ("180 UC", "180_UC", 34000),
        ("325 UC", "325_UC", 56000),
        ("660 UC", "660_UC", 112000),
        ("1800 UC", "1800_UC", 273000),
        ("3850 UC", "3850_UC", 530000),
        ("8100 UC", "8100_UC", 1070000)
    ]

    for uc_amount, callback, price in uc_prices_list:
        if discount > 0:
            discounted_price = price - (price * discount / 100)
            button_text = f"{uc_amount} - {int(discounted_price):,} Ù„.Ø³ ğŸŸï¸"
        else:
            button_text = f"{uc_amount} - {price:,} Ù„.Ø³"
        markup.add(types.InlineKeyboardButton(button_text, callback_data=callback))

    markup.add(types.InlineKeyboardButton("ğŸ’° ÙØ¦Ø© Ù…Ø®ØµØµØ©", callback_data="custom_amount"))
    markup.add(types.InlineKeyboardButton("â†©ï¸ Ø±Ø¬ÙˆØ¹", callback_data="back_to_games"))

    message_text = "ğŸ¯ Ø§Ø®ØªØ± ÙØ¦Ø© Ø§Ù„Ø´Ø­Ù† Ù„Ù€ PUBG:"
    if discount > 0:
        message_text += f"\n\nğŸŸï¸ ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø®ØµÙ… {discount}% Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±!"

    bot.edit_message_text(
        chat_id=chat_id,
        message_id=call.message.message_id,
        text=message_text,
        reply_markup=markup
    )

    schedule_reminder(call.message.chat.id)

@bot.callback_query_handler(func=lambda call: call.data.endswith('_UC') or call.data == 'custom_amount')
def handle_uc_selection(call):
    chat_id = call.message.chat.id

    if call.data == 'custom_amount':
        msg = send_clean_message(chat_id, "âŒ¨ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (Ø¨Ø§Ù„Ù„ÙŠØ±Ø© Ø§Ù„Ø³ÙˆØ±ÙŠØ©):")
        bot.register_next_step_handler(msg, process_custom_amount)
    else:
        uc_amount = call.data.split('_')[0]
        price = UC_PRICES.get(call.data, 0)
        user_data[chat_id] = {'uc_amount': uc_amount, 'price': price}

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¯ÙŠÙ‡ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø©
        user_info = get_user_data(call.from_user.id)
        if user_info and user_info.get('player_id'):
            markup = types.InlineKeyboardMarkup(row_width=2)
            btn_use_old = types.InlineKeyboardButton("Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©", callback_data="use_old_data")
            btn_new_data = types.InlineKeyboardButton("Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©", callback_data="enter_new_data")
            markup.add(btn_use_old, btn_new_data)

            send_clean_message(chat_id, f"""
ğŸ” Ù„Ø¯ÙŠÙƒ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹:

ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {user_info['full_name']}
ğŸ“± Ø§Ù„Ù‡Ø§ØªÙ: {user_info['phone']}
ğŸ†” ID Ø§Ù„Ù„Ø§Ø¹Ø¨: {user_info['player_id']}

Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ù… Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©ØŸ
            """, reply_markup=markup)
        else:
            msg = send_clean_message(chat_id, "ğŸ”¢ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ID Ø§Ù„Ù„Ø§Ø¹Ø¨ (ÙŠØ¬Ø¨ Ø£Ù† Ù„Ø§ ÙŠÙ‚Ù„ Ø¹Ù† 9 Ø®Ø§Ù†Ø§Øª):")
            bot.register_next_step_handler(msg, process_player_id)

    schedule_reminder(chat_id)

@bot.callback_query_handler(func=lambda call: call.data == 'use_old_data')
def use_old_data(call):
    chat_id = call.message.chat.id
    user_id = call.from_user.id

    user_info = get_user_data(user_id)
    if user_info:
        user_data[chat_id] = {
            'customer_name': user_info['full_name'],
            'phone': user_info['phone'],
            'player_id': user_info['player_id']
        }

        markup = types.InlineKeyboardMarkup()
        confirm_btn = types.InlineKeyboardButton("âœ… ØªØ£ÙƒÙŠØ¯", callback_data="confirm_phone")
        edit_btn = types.InlineKeyboardButton("âœï¸ ØªØ¹Ø¯ÙŠÙ„", callback_data="edit_phone")
        markup.add(confirm_btn, edit_btn)

        current_time = get_current_time().strftime("%H:%M")
        send_clean_message(chat_id, f"""
âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø³Ø§Ø¹Ø© {current_time}

Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨:

ğŸ†” ID: {user_info['player_id']}
ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {user_info['full_name']}
â˜ï¸ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: {user_info['phone']}

Ù‡Ù„ ÙƒÙ„ Ø´ÙŠØ¡ ØµØ­ÙŠØ­?
        """, reply_markup=markup)
    else:
        send_clean_message(chat_id, "âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹")
        msg = send_clean_message(chat_id, "ğŸ”¢ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ID Ø§Ù„Ù„Ø§Ø¹Ø¨ (ÙŠØ¬Ø¨ Ø£Ù† Ù„Ø§ ÙŠÙ‚Ù„ Ø¹Ù† 9 Ø®Ø§Ù†Ø§Øª):")
        bot.register_next_step_handler(msg, process_player_id)

    schedule_reminder(chat_id)

@bot.callback_query_handler(func=lambda call: call.data == 'enter_new_data')
def enter_new_data(call):
    chat_id = call.message.chat.id
    msg = send_clean_message(chat_id, "ğŸ”¢ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ID Ø§Ù„Ù„Ø§Ø¹Ø¨ (ÙŠØ¬Ø¨ Ø£Ù† Ù„Ø§ ÙŠÙ‚Ù„ Ø¹Ù† 9 Ø®Ø§Ù†Ø§Øª):")
    bot.register_next_step_handler(msg, process_player_id)
    schedule_reminder(chat_id)

def process_custom_amount(message):
    chat_id = message.chat.id
    delete_user_message(chat_id, message.message_id)

    try:
        price = int(message.text)
        user_data[chat_id] = {'uc_amount': 'Ù…Ø®ØµØµ', 'price': price}

        msg = send_clean_message(chat_id, "ğŸ”¢ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ID Ø§Ù„Ù„Ø§Ø¹Ø¨ (ÙŠØ¬Ø¨ Ø£Ù† Ù„Ø§ ÙŠÙ‚Ù„ Ø¹Ù† 9 Ø®Ø§Ù†Ø§Øª):")
        bot.register_next_step_handler(msg, process_player_id)
    except ValueError:
        send_clean_message(chat_id, "âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­")
        game_charging(message)

    schedule_reminder(chat_id)

def process_player_id(message):
    chat_id = message.chat.id
    delete_user_message(chat_id, message.message_id)
    player_id = message.text

    if not player_id.isdigit() or len(player_id) < 9:
        error_msg = "âŒ Ø®Ø·Ø£ ÙÙŠ ID Ø§Ù„Ù„Ø§Ø¹Ø¨\n\nâœ… ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· ÙˆÙ„Ø§ ÙŠÙ‚Ù„ Ø¹Ù† 9 Ø®Ø§Ù†Ø§Øª\nÙ…Ø«Ø§Ù„: 123456789"
        bot.send_message(chat_id, error_msg)
        time.sleep(8)  # Ø§Ù†ØªØ¸Ø§Ø± 8 Ø«ÙˆØ§Ù†ÙŠ
        game_charging(message)
        return

    user_data[chat_id]['player_id'] = player_id

    markup = types.InlineKeyboardMarkup()
    confirm_btn = types.InlineKeyboardButton("âœ… ØªØ£ÙƒÙŠØ¯", callback_data="confirm_player_id")
    edit_btn = types.InlineKeyboardButton("âœï¸ ØªØ¹Ø¯ÙŠÙ„", callback_data="edit_player_id")
    markup.add(confirm_btn, edit_btn)

    send_clean_message(chat_id, f"""
âœ… Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†:

ğŸ†” ID Ø§Ù„Ù„Ø§Ø¹Ø¨: {player_id}

Ù‡Ù„ ÙƒÙ„ Ø´ÙŠØ¡ ØµØ­ÙŠØ­?
    """, reply_markup=markup)

    schedule_reminder(chat_id)

@bot.callback_query_handler(func=lambda call: call.data in ['confirm_player_id', 'edit_player_id'])
def handle_player_id_confirmation(call):
    chat_id = call.message.chat.id

    if call.data == 'edit_player_id':
        msg = send_clean_message(chat_id, "ğŸ”¢ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ID Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰:")
        bot.register_next_step_handler(msg, process_player_id)
        return

    msg = send_clean_message(chat_id, f"ğŸ‘¤ Ø±Ø§Ø¦Ø¹! Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„:")
    bot.register_next_step_handler(msg, process_customer_name)

    schedule_reminder(chat_id)

def process_customer_name(message):
    chat_id = message.chat.id
    delete_user_message(chat_id, message.message_id)
    user_data[chat_id]['customer_name'] = message.text

    msg = send_clean_message(chat_id, f"""
âœ¨ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ {message.text}!

ğŸ“± Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø¹ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„ÙŠ:
Ù…Ø«Ø§Ù„: +963987654321
    """)
    bot.register_next_step_handler(msg, process_phone_number)

    schedule_reminder(chat_id)

def process_phone_number(message):
    chat_id = message.chat.id
    delete_user_message(chat_id, message.message_id)
    phone = message.text

    if not phone.startswith('+') or len(phone) < 11 or len(phone) > 14:
        error_msg = """
âŒ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­

âœ… ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø±Ù‚Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ù€ + ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 11 Ø¥Ù„Ù‰ 13 Ø®Ø§Ù†Ø©
Ù…Ø«Ø§Ù„: +963987654321
        """
        bot.send_message(chat_id, error_msg)
        time.sleep(8)  # Ø§Ù†ØªØ¸Ø§Ø± 8 Ø«ÙˆØ§Ù†ÙŠ
        msg = send_clean_message(chat_id, "ğŸ“± Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø¹ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„ÙŠ:")
        bot.register_next_step_handler(msg, process_phone_number)
        return

    user_data[chat_id]['phone'] = phone

    markup = types.InlineKeyboardMarkup()
    confirm_btn = types.InlineKeyboardButton("âœ… ØªØ£ÙƒÙŠØ¯", callback_data="confirm_phone")
    edit_btn = types.InlineKeyboardButton("âœï¸ ØªØ¹Ø¯ÙŠÙ„", callback_data="edit_phone")
    markup.add(confirm_btn, edit_btn)

    current_time = get_current_time().strftime("%H:%M")
    send_clean_message(chat_id, f"""
âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø³Ø§Ø¹Ø© {current_time}

Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨:

ğŸ†” ID: {user_data[chat_id].get('player_id', '')}
ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {user_data[chat_id].get('customer_name', '')}
â˜ï¸ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: {phone}

Ù‡Ù„ ÙƒÙ„ Ø´ÙŠØ¡ ØµØ­ÙŠØ­?
    """, reply_markup=markup)

    schedule_reminder(chat_id)

@bot.callback_query_handler(func=lambda call: call.data in ['confirm_phone', 'edit_phone'])
def handle_phone_confirmation(call):
    chat_id = call.message.chat.id

    if call.data == 'edit_phone':
        msg = send_clean_message(chat_id, "ğŸ“± Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø¹ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„ÙŠ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰:")
        bot.register_next_step_handler(msg, process_phone_number)
        return

    send_otp(chat_id)
    schedule_reminder(chat_id)

def send_otp(chat_id):
    secret = pyotp.random_base32()
    otp_secrets[chat_id] = {
        'secret': secret,
        'timestamp': time.time(),
        'attempts': 0
    }

    totp = pyotp.TOTP(secret, digits=6, interval=180)
    otp_code = totp.now()

    markup = types.InlineKeyboardMarkup()
    resend_btn = types.InlineKeyboardButton("ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„", callback_data="resend_otp")
    markup.add(resend_btn)

    msg = send_clean_message(chat_id, f"""
ğŸ” Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:

{otp_code}

â³ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ù…Ø²: 3 Ø¯Ù‚Ø§Ø¦Ù‚

Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚:
    """, reply_markup=markup)

    bot.register_next_step_handler(msg, verify_otp)
    schedule_reminder(chat_id)

@bot.callback_query_handler(func=lambda call: call.data =='resend_otp')
def resend_otp(call):
    chat_id = call.message.chat.id
    send_otp(chat_id)
    schedule_reminder(chat_id)

def verify_otp(message):
    chat_id = message.chat.id
    delete_user_message(chat_id, message.message_id)
    user_otp = message.text.strip()

    otp_data = otp_secrets.get(chat_id)

    if not otp_data:
        send_clean_message(chat_id, "âš ï¸ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯")
        return

    otp_data['attempts'] += 1
    otp_secrets[chat_id] = otp_data

    if otp_data['attempts'] > 3:
        send_clean_message(chat_id, "âš ï¸ ØªØ¬Ø§ÙˆØ²Øª Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯")
        del otp_secrets[chat_id]
        return

    totp = pyotp.TOTP(otp_data['secret'], digits=6, interval=180)

    if totp.verify(user_otp):
        send_clean_message(chat_id, "âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­!")
        show_payment_options(message)
    else:
        markup = types.InlineKeyboardMarkup()
        resend_btn = types.InlineKeyboardButton("ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„", callback_data="resend_otp")
        markup.add(resend_btn)

        remaining_attempts = 3 - otp_data['attempts']
        msg = send_clean_message(
            chat_id, 
            f"âš ï¸ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­\n\nÙ„Ø¯ÙŠÙƒ {remaining_attempts} Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…ØªØ¨Ù‚ÙŠØ©",
            reply_markup=markup
        )
        bot.register_next_step_handler(msg, verify_otp)

    schedule_reminder(chat_id)

def show_payment_options(message):
    chat_id = message.chat.id

    # ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®ØµÙ… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹
    discount = user_data.get(chat_id, {}).get('discount', 0)
    original_price = user_data.get(chat_id, {}).get('price', 0)

    if discount > 0:
        discounted_price = original_price - (original_price * discount / 100)
        user_data[chat_id]['final_price'] = discounted_price
    else:
        user_data[chat_id]['final_price'] = original_price

    markup = types.InlineKeyboardMarkup(row_width=1)

    options = [
        ("ğŸ’³ Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ø§Ù„Ø¨Ù†ÙƒÙŠØ© (ğŸš§ Ù‚Ø±ÙŠØ¨Ø§Ù‹)", "bank_transfer"),
        ("â‚¿ Coinex (BSC - BEP20)", "coinex"),
        ("ğŸ’ Ø´Ø§Ù… ÙƒØ§Ø´ (ğŸš§ Ù‚Ø±ÙŠØ¨Ø§Ù‹)", "sham_cash"),
        ("ğŸ“± Ø³ÙŠØ±ÙŠØ§ØªÙŠÙ„ ÙƒØ§Ø´", "syriatel_cash"),
        ("ğŸ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§", "gift_cards"),
        ("ğŸ’µ Payoneer (ğŸš§ Ù‚Ø±ÙŠØ¨Ø§Ù‹)", "payoneer"),
        ("â†©ï¸ Ø±Ø¬ÙˆØ¹", "back_to_pubg")
    ]

    for text, callback in options:
        markup.add(types.InlineKeyboardButton(text, callback_data=callback))

    order_data = user_data.get(chat_id, {})

    price_msg = f"""
ğŸ’° Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:

ğŸ”¹ ÙØ¦Ø© UC: {order_data.get('uc_amount', '')}
"""

    if order_data.get('discount', 0) > 0:
        price_msg += f"""
ğŸ’µ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ: {order_data.get('price', '')} Ù„.Ø³
ğŸŸï¸ Ø§Ù„Ø®ØµÙ…: {order_data.get('discount')}%
ğŸ’° Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: {int(order_data.get('final_price', 0))} Ù„.Ø³
"""
    else:
        price_msg += f"ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: {order_data.get('price', '')} Ù„.Ø³"

    price_msg += "\nØ§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©:"

    send_clean_message(chat_id, price_msg, reply_markup=markup)

    schedule_reminder(chat_id)

@bot.callback_query_handler(func=lambda call: call.data in [
    'bank_transfer', 'coinex', 'sham_cash', 
    'syriatel_cash', 'gift_cards', 'payoneer'
])
def handle_payment_method(call):
    chat_id = call.message.chat.id
    method = call.data

    if method == 'bank_transfer':
        markup = types.InlineKeyboardMarkup()
        back_btn = types.InlineKeyboardButton("â†©ï¸ Ø±Ø¬ÙˆØ¹", callback_data="back_to_payment")
        markup.add(back_btn)

        send_clean_message(chat_id, "âš ï¸ Ø§Ù„Ø®Ø¯Ù…Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹", reply_markup=markup)

    elif method == 'coinex':
        markup = types.InlineKeyboardMarkup()
        confirm_btn = types.InlineKeyboardButton("âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„", callback_data="confirm_coinex")
        back_btn = types.InlineKeyboardButton("â†©ï¸ Ø±Ø¬ÙˆØ¹", callback_data="back_to_payment")
        markup.add(confirm_btn, back_btn)

        send_clean_message(chat_id, """
ğŸ“Œ Ù„Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Coinex (BSC - BEP20):

ğŸ”¹ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©:
`0x694142b6a4c9dc077220ee037f1c42bd7b4d68b5`

Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø«Ù… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„
        """, reply_markup=markup, parse_mode="Markdown")

    elif method in ['sham_cash', 'payoneer']:
        markup = types.InlineKeyboardMarkup()
        back_btn = types.InlineKeyboardButton("â†©ï¸ Ø±Ø¬ÙˆØ¹", callback_data="back_to_payment")
        markup.add(back_btn)

        send_clean_message(chat_id, "â³ Ø³ØªØªÙˆÙØ± Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø¯Ù…Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹", reply_markup=markup)

    elif method == 'syriatel_cash':
        markup = types.InlineKeyboardMarkup()
        amount_btn = types.InlineKeyboardButton("ğŸ’° Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº", callback_data="enter_syriatel_amount")
        back_btn = types.InlineKeyboardButton("â†©ï¸ Ø±Ø¬ÙˆØ¹", callback_data="back_to_payment")
        markup.add(amount_btn, back_btn)

        send_clean_message(chat_id, """
ğŸ’³ Ù„Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Ø³ÙŠØ±ÙŠØ§ØªÙŠÙ„ ÙƒØ§Ø´:

ğŸ”¹ Ù‚Ù… Ø¨ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ø¥Ù„Ù‰ Ø£Ø­Ø¯ Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ØªØ§Ù„ÙŠØ©:
74962454
78833277

Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº"
        """, reply_markup=markup)

    elif method == 'gift_cards':
        markup = types.InlineKeyboardMarkup(row_width=1)
        telegram_btn = types.InlineKeyboardButton("ğŸ“² ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…", url=f"https://t.me/{SUPPORT_TELEGRAM[1:]}")
        whatsapp_btn = types.InlineKeyboardButton("ğŸ“± ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨", url=f"https://wa.me/{SUPPORT_WHATSAPP[1:]}")
        back_btn = types.InlineKeyboardButton("â†©ï¸ Ø±Ø¬ÙˆØ¹", callback_data="back_to_payment")
        markup.add(telegram_btn, whatsapp_btn, back_btn)

        send_clean_message(chat_id, """
ğŸ Ù„Ù„Ø¯ÙØ¹ Ø¨Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§:

ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ¬Ø± Ù„Ø£ØªÙ…Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        """, reply_markup=markup)

    schedule_reminder(chat_id)

@bot.callback_query_handler(func=lambda call: call.data == 'enter_syriatel_amount')
def ask_for_syriatel_amount(call):
    chat_id = call.message.chat.id
    msg = send_clean_message(chat_id, "ğŸ’° Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡:")
    bot.register_next_step_handler(msg, process_syriatel_amount)

    schedule_reminder(chat_id)

def process_syriatel_amount(message):
    chat_id = message.chat.id
    delete_user_message(chat_id, message.message_id)

    try:
        amount = int(message.text)
        user_data[chat_id]['paid_amount'] = amount

        msg = send_clean_message(chat_id, "ğŸ“¤ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ø¥Ø«Ø¨Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø³ÙŠØ±ÙŠØ§ØªÙŠÙ„ ÙƒØ§Ø´:")
        bot.register_next_step_handler(msg, process_syriatel_payment)
    except ValueError:
        send_clean_message(chat_id, "âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­")
        ask_for_syriatel_amount(message)

    schedule_reminder(chat_id)

def process_syriatel_payment(message):
    chat_id = message.chat.id
    delete_user_message(chat_id, message.message_id)

    if not message.photo:
        send_clean_message(chat_id, "âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© ØµØ­ÙŠØ­Ø©")
        msg = send_clean_message(chat_id, "ğŸ“¤ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ø¥Ø«Ø¨Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„:")
        bot.register_next_step_handler(msg, process_syriatel_payment)
        return

    # Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    save_user(
        user_id=message.from_user.id,
        username=message.from_user.username,
        full_name=user_data[chat_id].get('customer_name', ''),
        phone=user_data[chat_id].get('phone', ''),
        player_id=user_data[chat_id].get('player_id', '')
    )

    # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨
    order_id = create_order(
        user_id=message.from_user.id,
        game_name="PUBG",
        uc_amount=user_data[chat_id].get('uc_amount', ''),
        player_id=user_data[chat_id].get('player_id', ''),
        price=user_data[chat_id].get('price', 0),
        paid_amount=user_data[chat_id].get('paid_amount', 0),
        payment_method="Ø³ÙŠØ±ÙŠØ§ØªÙŠÙ„ ÙƒØ§Ø´"
    )

    # Ø¥Ø±Ø³Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„
    markup = types.InlineKeyboardMarkup(row_width=1)
    telegram_btn = types.InlineKeyboardButton("ğŸ“² ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…", url=f"https://t.me/{SUPPORT_TELEGRAM[1:]}")
    whatsapp_btn = types.InlineKeyboardButton("ğŸ“± ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨", url=f"https://wa.me/{SUPPORT_WHATSAPP[1:]}")
    dev_btn = types.InlineKeyboardButton("ğŸ‘¨â€ğŸ’» Ø§Ù„Ù…Ø·ÙˆØ±", url=f"https://t.me/{DEV_ACCOUNT[1:]}")
    channel_btn = types.InlineKeyboardButton("ğŸ“¢ Ù‚Ù†Ø§Ø© Ø§Ù„Ù…ØªØ¬Ø±", url=NEWS_CHANNEL)
    markup.add(telegram_btn, whatsapp_btn, dev_btn, channel_btn)

    send_clean_message(chat_id, f"""
âœ¨ Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ Ù…ØªØ¬Ø± Ø±ÙŠÙ…Ø§!

â³ Ø·Ù„Ø¨Ùƒ {format_order_id(order_id)} Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ³ÙŠØªÙ… ØªØ£ÙƒÙŠØ¯Ù‡ Ø®Ù„Ø§Ù„ 60 Ø¯Ù‚ÙŠÙ‚Ø©.

Ù„Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø± ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø±:
    """, reply_markup=markup)

    # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ù‚Ù†Ø§Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
    order_msg = f"""
ğŸš¨ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ {format_order_id(order_id)} (Ø³ÙŠØ±ÙŠØ§ØªÙŠÙ„ ÙƒØ§Ø´) ğŸš¨

ğŸ® Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨: Ø´Ø­Ù† {user_data[chat_id].get('uc_amount', '')} UC
ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: {user_data[chat_id].get('price', '')} Ù„.Ø³
ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹: {user_data[chat_id].get('paid_amount', '')} Ù„.Ø³
ğŸ†” ID Ø§Ù„Ù„Ø§Ø¹Ø¨: {user_data[chat_id].get('player_id', '')}
ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: {user_data[chat_id].get('customer_name', '')}
ğŸ“± Ø§Ù„Ù‡Ø§ØªÙ: {user_data[chat_id].get('phone', '')}
ğŸ’³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: Ø³ÙŠØ±ÙŠØ§ØªÙŠÙ„ ÙƒØ§Ø´
ğŸ‘¤ Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨: @{message.from_user.username if message.from_user.username else 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}
    """

    markup_admin = types.InlineKeyboardMarkup()
    btn_complete = types.InlineKeyboardButton("âœ… ØªÙ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨", callback_data=f"complete_{order_id}")
    btn_reject = types.InlineKeyboardButton("âŒ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨", callback_data=f"reject_{order_id}")
    markup_admin.add(btn_complete, btn_reject)

    bot.send_photo(
        ADMIN_CHANNEL, 
        message.photo[-1].file_id, 
        caption=order_msg,
        reply_markup=markup_admin
    )

    if chat_id in user_data:
        del user_data[chat_id]

@bot.callback_query_handler(func=lambda call: call.data.startswith(('complete_', 'reject_')))
def handle_order_status(call):
    action, order_id = call.data.split('_')
    order_id = int(order_id)

    if action == 'complete':
        update_order_status(order_id, 'completed')

        conn = sqlite3.connect('rema_store.db')
        cursor = conn.cursor()
        cursor.execute('SELECT user_id FROM orders WHERE order_id = ?', (order_id,))
        result = cursor.fetchone()
        conn.close()

        if result:
            user_id = result[0]

            markup = types.InlineKeyboardMarkup()
            channel_btn = types.InlineKeyboardButton("ğŸ“¢ Ù‚Ù†Ø§Ø© Ø§Ù„Ù…ØªØ¬Ø±", url=NEWS_CHANNEL)
            markup.add(channel_btn)

            bot.send_message(user_id, f"""
ğŸ‰ ØªÙ… Ø¥ØªÙ…Ø§Ù… Ø·Ù„Ø¨Ùƒ {format_order_id(order_id)} Ø¨Ù†Ø¬Ø§Ø­!

Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒ Ø¨Ù…ØªØ¬Ø± Ø±ÙŠÙ…Ø§. Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ ØªØ¬Ø±Ø¨Ø© Ù…Ù…ØªØ¹Ø©!

âœ¨ Ù„Ø§ ØªÙ†Ø³Ù Ù…ØªØ§Ø¨Ø¹Ø© Ù‚Ù†Ø§Ø© Ø§Ù„Ù…ØªØ¬Ø± Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„Ø®ØµÙˆÙ…Ø§Øª!
            """, reply_markup=markup)

        bot.edit_message_caption(
            chat_id=call.message.chat.id,
            message_id=call.message.message_id,
            caption=call.message.caption + "\n\nâœ… ØªÙ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨",
            reply_markup=None
        )

    elif action == 'reject':
        update_order_status(order_id, 'rejected')

        conn = sqlite3.connect('rema_store.db')
        cursor = conn.cursor()
        cursor.execute('SELECT user_id FROM orders WHERE order_id = ?', (order_id,))
        result = cursor.fetchone()
        conn.close()

        if result:
            user_id = result[0]
            markup = types.InlineKeyboardMarkup()
            support_btn = types.InlineKeyboardButton("ğŸ“ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…", url=f"https://t.me/{SUPPORT_TELEGRAM[1:]}")
            markup.add(support_btn)

            bot.send_message(user_id, f"""
âš ï¸ Ø¹Ø°Ø±Ø§Ù‹ØŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨Ùƒ {format_order_id(order_id)}

Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ
            """, reply_markup=markup)

        bot.edit_message_caption(
            chat_id=call.message.chat.id,
            message_id=call.message.message_id,
            caption=call.message.caption + "\n\nâŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨",
            reply_markup=None
        )

@bot.callback_query_handler(func=lambda call: call.data == 'confirm_coinex')
def confirm_coinex(call):
    chat_id = call.message.chat.id
    msg = send_clean_message(chat_id, "ğŸ“¤ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ø¥Ø«Ø¨Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„:")
    bot.register_next_step_handler(msg, process_coinex_payment)

    schedule_reminder(chat_id)

def process_coinex_payment(message):
    chat_id = message.chat.id
    delete_user_message(chat_id, message.message_id)

    if not message.photo:
        send_clean_message(chat_id, "âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© ØµØ­ÙŠØ­Ø©")
        msg = send_clean_message(chat_id, "ğŸ“¤ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ø¥Ø«Ø¨Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„:")
        bot.register_next_step_handler(msg, process_coinex_payment)
        return

    save_user(
        user_id=message.from_user.id,
        username=message.from_user.username,
        full_name=user_data[chat_id].get('customer_name', ''),
        phone=user_data[chat_id].get('phone', ''),
        player_id=user_data[chat_id].get('player_id', '')
    )

    order_id = create_order(
        user_id=message.from_user.id,
        game_name="PUBG",
        uc_amount=user_data[chat_id].get('uc_amount', ''),
        player_id=user_data[chat_id].get('player_id', ''),
        price=user_data[chat_id].get('price', 0),
        paid_amount=user_data[chat_id].get('price', 0),
        payment_method="Coinex (BSC - BEP20)"
    )

    markup = types.InlineKeyboardMarkup(row_width=1)
    telegram_btn = types.InlineKeyboardButton("ğŸ“² ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…", url=f"https://t.me/{SUPPORT_TELEGRAM[1:]}")
    whatsapp_btn = types.InlineKeyboardButton("ğŸ“± ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨", url=f"https://wa.me/{SUPPORT_WHATSAPP[1:]}")
    dev_btn = types.InlineKeyboardButton("ğŸ‘¨â€ğŸ’» Ø§Ù„Ù…Ø·ÙˆØ±", url=f"https://t.me/{DEV_ACCOUNT[1:]}")
    channel_btn = types.InlineKeyboardButton("ğŸ“¢ Ù‚Ù†Ø§Ø© Ø§Ù„Ù…ØªØ¬Ø±", url=NEWS_CHANNEL)
    markup.add(telegram_btn, whatsapp_btn, dev_btn, channel_btn)

    send_clean_message(chat_id, f"""
âœ¨ Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ Ù…ØªØ¬Ø± Ø±ÙŠÙ…Ø§!

â³ Ø·Ù„Ø¨Ùƒ {format_order_id(order_id)} Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ³ÙŠØªÙ… ØªØ£ÙƒÙŠØ¯Ù‡ Ø®Ù„Ø§Ù„ 60 Ø¯Ù‚ÙŠÙ‚Ø©.

Ù„Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø± ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø±:
    """, reply_markup=markup)

    order_msg = f"""
ğŸš¨ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ {format_order_id(order_id)} (Coinex) ğŸš¨

ğŸ® Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨: Ø´Ø­Ù† {user_data[chat_id].get('uc_amount', '')} UC
ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {user_data[chat_id].get('price', '')} Ù„.Ø³
ğŸ†” ID Ø§Ù„Ù„Ø§Ø¹Ø¨: {user_data[chat_id].get('player_id', '')}
ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: {user_data[chat_id].get('customer_name', '')}
ğŸ“± Ø§Ù„Ù‡Ø§ØªÙ: {user_data[chat_id].get('phone', '')}
ğŸ’³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: Coinex (BSC - BEP20)
ğŸ‘¤ Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨: @{message.from_user.username if message.from_user.username else 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}
    """

    markup_admin = types.InlineKeyboardMarkup()
    btn_complete = types.InlineKeyboardButton("âœ… ØªÙ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨", callback_data=f"complete_{order_id}")
    btn_reject = types.InlineKeyboardButton("âŒ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨", callback_data=f"reject_{order_id}")
    markup_admin.add(btn_complete, btn_reject)

    bot.send_photo(
        ADMIN_CHANNEL, 
        message.photo[-1].file_id, 
        caption=order_msg,
        reply_markup=markup_admin
    )

    if chat_id in user_data:
        del user_data[chat_id]

@bot.callback_query_handler(func=lambda call: call.data == 'back_to_payment')
def back_to_payment(call):
    show_payment_options(call.message)

@bot.callback_query_handler(func=lambda call: call.data == 'back_to_pubg')
def back_to_pubg(call):
    pubg_charging(call)

@bot.callback_query_handler(func=lambda call: call.data == 'back_to_games')
def back_to_games(call):
    game_charging(call.message)

@bot.message_handler(func=lambda message: message.text == 'ğŸ“ ØªÙˆØ§ØµÙ„')
def contact_us(message):
    markup = types.InlineKeyboardMarkup(row_width=1)

    telegram_btn = types.InlineKeyboardButton("ğŸ“² ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…", url=f"https://t.me/{SUPPORT_TELEGRAM[1:]}")
    whatsapp_btn = types.InlineKeyboardButton("ğŸ“± ÙˆØ§ØªØ³Ø§Ø¨", url=f"https://wa.me/{SUPPORT_WHATSAPP[1:]}")
    dev_btn = types.InlineKeyboardButton("ğŸ‘¨â€ğŸ’» Ø§Ù„Ù…Ø·ÙˆØ±", url=f"https://t.me/{DEV_ACCOUNT[1:]}")
    back_btn = types.InlineKeyboardButton("â†©ï¸ Ø±Ø¬ÙˆØ¹", callback_data="back_to_main")

    markup.add(telegram_btn, whatsapp_btn, dev_btn, back_btn)

    send_clean_message(message.chat.id, """
ğŸ“ ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§:

ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ ÙØ±ÙŠÙ‚ Ø§Ù„Ø¯Ø¹Ù… Ø¹Ø¨Ø±:
    """, reply_markup=markup)

@bot.message_handler(func=lambda message: message.text == 'ğŸ“¢ Ù‚Ù†Ø§Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø±')
def trust_channel(message):
    markup = types.InlineKeyboardMarkup()

    channel_btn = types.InlineKeyboardButton("ğŸ“¢ Ø§Ù†Ø¶Ù… Ù„Ù„Ù‚Ù†Ø§Ø©", url=NEWS_CHANNEL)
    back_btn = types.InlineKeyboardButton("â†©ï¸ Ø±Ø¬ÙˆØ¹", callback_data="back_to_main")

    markup.add(channel_btn, back_btn)

    send_clean_message(message.chat.id, """
ğŸ“¢ Ù‚Ù†Ø§Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø± ÙˆØ§Ù„Ø¹Ø±ÙˆØ¶:

ØªØ§Ø¨Ø¹ Ø¢Ø®Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙˆØ§Ù„Ø¹Ø±ÙˆØ¶ Ø¹Ù„Ù‰ Ù‚Ù†Ø§ØªÙ†Ø§ Ø§Ù„Ø±Ø³Ù…ÙŠØ©
    """, reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data == 'back_to_main')
def back_to_main(call):
    send_welcome(call.message)

@bot.message_handler(func=lambda message: message.text == 'ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ')
def my_account(message):
    chat_id = message.chat.id
    user_id = message.from_user.id

    conn = sqlite3.connect('rema_store.db')
    cursor = conn.cursor()

    # Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    cursor.execute('''
    SELECT full_name, phone, player_id, registration_date 
    FROM users WHERE user_id = ?
    ''', (user_id,))
    user_info = cursor.fetchone()

    # Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©
    cursor.execute('''
    SELECT COUNT(*) FROM orders 
    WHERE user_id = ? AND status = 'completed'
    ''', (user_id,))
    completed_orders = cursor.fetchone()[0]

    # Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ø·Ù„Ø¨
    cursor.execute('''
    SELECT order_date, status FROM orders 
    WHERE user_id = ? ORDER BY order_date DESC LIMIT 1
    ''', (user_id,))
    last_order = cursor.fetchone()

    conn.close()

    damascus_tz = pytz.timezone('Asia/Damascus')
    current_time = datetime.now(damascus_tz).strftime("%Y-%m-%d %H:%M:%S")

    if user_info:
        markup = types.InlineKeyboardMarkup(row_width=1)
        edit_name_btn = types.InlineKeyboardButton("âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…", callback_data="edit_name")
        edit_phone_btn = types.InlineKeyboardButton("âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ", callback_data="edit_phone")
        edit_id_btn = types.InlineKeyboardButton("âœï¸ ØªØ¹Ø¯ÙŠÙ„ ID Ø§Ù„Ù„Ø§Ø¹Ø¨", callback_data="edit_player_id")
        back_btn = types.InlineKeyboardButton("â†©ï¸ Ø±Ø¬ÙˆØ¹", callback_data="back_to_main")
        markup.add(edit_name_btn, edit_phone_btn, edit_id_btn, back_btn)

        account_msg = f"""
ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­Ø³Ø§Ø¨Ùƒ:

Ø§Ù„Ø§Ø³Ù…: {user_info[0]}
Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: {user_info[1]}
ID Ø§Ù„Ù„Ø§Ø¹Ø¨: {user_info[2]}
ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„: {user_info[3]}

ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:
Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©: {completed_orders}
"""
        if last_order:
            account_msg += f"""
Ø¢Ø®Ø± Ø·Ù„Ø¨:
Ø§Ù„ØªØ§Ø±ÙŠØ®: {last_order[0]}
Ø§Ù„Ø­Ø§Ù„Ø©: {last_order[1]}
"""

        account_msg += f"\nâ° Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ: {current_time}"

        send_clean_message(chat_id, account_msg, reply_markup=markup)
    else:
        markup = types.InlineKeyboardMarkup()
        back_btn = types.InlineKeyboardButton("â†©ï¸ Ø±Ø¬ÙˆØ¹", callback_data="back_to_main")
        markup.add(back_btn)
        send_clean_message(chat_id, "âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨. ÙŠØ±Ø¬Ù‰ Ø¥Ø¬Ø±Ø§Ø¡ Ø·Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹.", reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data in ['edit_name', 'edit_phone', 'edit_player_id'])
def handle_edit_profile(call):
    chat_id = call.message.chat.id
    edit_type = call.data.split('_')[1]

    if edit_type == 'name':
        msg = send_clean_message(chat_id, "ğŸ‘¤ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:")
        bot.register_next_step_handler(msg, process_new_name)
    elif edit_type == 'phone':
        msg = send_clean_message(chat_id, "ğŸ“± Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„ÙŠ:")
        bot.register_next_step_handler(msg, process_new_phone)
    elif edit_type == 'player_id':
        msg = send_clean_message(chat_id, "ğŸ”¢ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ID Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯:")
        bot.register_next_step_handler(msg, process_new_player_id)

def process_new_name(message):
    chat_id = message.chat.id
    new_name = message.text
    user_id = message.from_user.id

    conn = sqlite3.connect('rema_store.db')
    cursor = conn.cursor()
    cursor.execute('UPDATE users SET full_name = ? WHERE user_id = ?', (new_name, user_id))
    conn.commit()
    conn.close()

    send_clean_message(chat_id, "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­!")
    my_account(message)

def process_new_phone(message):
    chat_id = message.chat.id
    new_phone = message.text
    user_id = message.from_user.id

    if not new_phone.startswith('+') or len(new_phone) < 11 or len(new_phone) > 14:
        send_clean_message(chat_id, "âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ + ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 11-14 Ø±Ù‚Ù….")
        return

    conn = sqlite3.connect('rema_store.db')
    cursor = conn.cursor()
    cursor.execute('UPDATE users SET phone = ? WHERE user_id = ?', (new_phone, user_id))
    conn.commit()
    conn.close()

    send_clean_message(chat_id, "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¨Ù†Ø¬Ø§Ø­!")
    my_account(message)

@bot.message_handler(func=lambda message: message.text == 'ğŸ”™ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©')
def back_to_main_menu(message):
    send_welcome(message)

def process_new_player_id(message):
    chat_id = message.chat.id
    new_player_id = message.text
    user_id = message.from_user.id

    if not new_player_id.isdigit() or len(new_player_id) < 9:
        send_clean_message(chat_id, "âš ï¸ ID Ø§Ù„Ù„Ø§Ø¹Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙƒÙˆÙ† Ù…Ù† 9 Ø£Ø±Ù‚Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.")
        return

    conn = sqlite3.connect('rema_store.db')
    cursor = conn.cursor()
    cursor.execute('UPDATE users SET player_id = ? WHERE user_id = ?', (new_player_id, user_id))
    conn.commit()
    conn.close()

    send_clean_message(chat_id, "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ID Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¨Ù†Ø¬Ø§Ø­!")
    my_account(message)

@bot.callback_query_handler(func=lambda call: call.data == 'coming_soon')
def coming_soon(call):
    bot.answer_callback_query(call.id, "â³ Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø¯Ù…Ø© Ø³ØªØªÙˆÙØ± Ù‚Ø±ÙŠØ¨Ø§Ù‹!", show_alert=True)

@bot.callback_query_handler(func=lambda call: call.data == 'start_order')
def start_order(call):
    game_charging(call.message)

@bot.callback_query_handler(func=lambda call: call.data.startswith('complete_order_'))
def complete_order(call):
    order_id = int(call.data.split('_')[2])
    status = get_order_status(order_id)

    if status == 'completed':
        bot.answer_callback_query(call.id, "âœ… Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ ØªÙ… Ø¥ØªÙ…Ø§Ù…Ù‡ Ø¨Ø§Ù„ÙØ¹Ù„", show_alert=True)
    elif status == 'rejected':
        bot.answer_callback_query(call.id, "âŒ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ ØªÙ… Ø±ÙØ¶Ù‡", show_alert=True)
    else:
        show_payment_options(call.message)

def schedule_backup():
    """Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª"""
    backup_database()
    Timer(21600, schedule_backup).start()

if __name__ == '__main__':
    print("âœ… Bot is running...")
    # Ø¨Ø¯Ø¡ Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
    schedule_backup()
    bot.infinity_polling()